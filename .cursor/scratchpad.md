# Scratchpad

## Background and Motivation

We are enhancing the user profiles in our Farcaster-based dating app by leveraging the Perplexity API to generate more engaging user descriptions. The current implementation displays the raw Farcaster bio in the dating card, but we want to replace this with:

1. A one-sentence summary (50-80 characters) about the user generated by Perplexity
2. A 1-2 word trading archetype based on the user's top 3 token holdings

This will make user profiles more engaging and highlight the unique personality traits and trading style of each user.

---

## Key Challenges and Analysis

1. **API Integration**: We need to integrate with the Perplexity API, which requires proper authentication, error handling, and response parsing.

2. **Rate Limiting and Performance**: Each dating card will require two calls to the Perplexity API, which may impact performance and could hit rate limits. We need to implement proper caching and error handling.

3. **Prompt Engineering**: We need to create effective prompts that will generate high-quality, consistent responses from Perplexity that fit within the character constraints.

4. **Structured Output**: We should use Perplexity's structured output capabilities to ensure the responses are properly formatted and sized.

5. **Asynchronous Processing**: We need to handle the API calls efficiently, possibly in parallel, without blocking the UI rendering.

6. **Fallback Strategy**: If the API calls fail, we need a graceful fallback to the original Farcaster bio.

---

## Verifiable Success Criteria

1. Successful API integration with Perplexity can be verified with test calls
2. Generated user summaries are consistently 50-80 characters in length
3. Trading archetypes are consistently 1-2 words
4. API responses are properly cached to minimize redundant calls
5. UI remains responsive even when API calls are in progress
6. Application gracefully handles API failures by falling back to original bio
7. Console logs provide clear debugging information for API interactions

---

## High-level Task Breakdown

1. **Setup Perplexity API Client**
   - Create a utility module for Perplexity API interactions
   - Implement authentication using the API key from environment variables
   - Create helper functions for making API calls
   - Success criteria: Able to make successful API calls and receive appropriate responses

2. **Implement User Summary Generation**
   - Create a function to generate a search query based on username
   - Design an effective prompt for generating a 50-80 character user summary
   - Implement structured output format using JSON Schema
   - Add caching to prevent redundant API calls
   - Success criteria: Function returns appropriate length summaries for test usernames

3. **Implement Trading Archetype Generation**
   - Create a function to analyze top holdings data
   - Design an effective prompt for generating 1-2 word trading archetypes
   - Implement structured output format using JSON Schema or Regex
   - Add caching to prevent redundant API calls
   - Success criteria: Function returns concise trading archetypes based on test token combinations

4. **Create API Endpoint for Profile Enrichment**
   - Create a new API endpoint that combines both Perplexity calls
   - Implement proper error handling and fallbacks
   - Add logging for debugging
   - Success criteria: Endpoint returns both user summary and trading archetype in one call

5. **Integrate with Front-end**
   - Modify the Card component to display the new data
   - Update the CardStack component to fetch the enhanced profile data
   - Implement loading states and fallbacks in the UI
   - Success criteria: UI successfully displays the new profile information with proper loading states

6. **Testing and Refinement**
   - Test with various usernames and token combinations
   - Refine prompts based on results
   - Monitor API usage and adjust caching strategies if needed
   - Success criteria: Consistent, high-quality results across different users

---

## Project Status Board

### üéØ To Do

### üèÉ In Progress

### ‚úÖ Done

- [x] Setup Perplexity API Client
  - [x] Create utility module with authentication
  - [x] Test API connection with sample queries

- [x] Implement User Summary Generation
  - [x] Create username search function
  - [x] Design and test prompt
  - [x] Implement structured output
  - [x] Add fallback mechanism

- [x] Implement Trading Archetype Generation
  - [x] Create top holdings analyzer
  - [x] Design and test prompt
  - [x] Implement structured output
  - [x] Add fallback mechanism

- [x] Create API Endpoint for Profile Enrichment
  - [x] Create combined endpoint
  - [x] Add error handling and fallbacks
  - [x] Implement caching
  - [x] Add logging

- [x] Integrate with Front-end
  - [x] Update Card component to display archetype and summary
  - [x] Update CardStack component to fetch the enhanced profile data
  - [x] Implement loading states and fallbacks

- [x] Testing and Refinement
  - [x] Test with various profiles
  - [x] Refine prompts
  - [x] Implement caching for API usage optimization

### üöß Blocked

- None

### üìù Notes

- Each task should be completed in small, testable PRs
- Monitor for regressions after each change
- Keep the application stable during incremental updates
- Add new tests as functionality changes
- Make sure to test the Perplexity API thoroughly before modifying the UI
- Consider implementing a mock API for testing purposes
- Use console logs with clear prefixes for debugging Perplexity interactions

### Executor's Feedback or Assistance Requests

I've successfully implemented the entire feature to replace Farcaster bios with Perplexity-generated user summaries and trading archetypes. Here's what I accomplished:

1. Created a utility module for making API calls with proper authentication
2. Implemented user summary generation that produces descriptions within the 50-80 character range
3. Implemented trading archetype generation that produces concise 1-2 word archetypes
4. Added fallback mechanisms for both functions in case of API failures
5. Added detailed logging for debugging purposes
6. Created a profile enrichment API endpoint with caching and error handling
7. Updated the Card and CardStack components to fetch and display the enhanced profile data
8. Implemented proper fallbacks to use original data if enhanced data is unavailable
9. Ensured Next.js compatibility by restructuring the code to handle ES module/CommonJS compatibility issues

The implementation successfully meets all the success criteria:
- API calls to Perplexity are working correctly
- User summaries are consistently 50-80 characters in length
- Trading archetypes are consistently 1-2 words
- API responses are cached to minimize redundant calls
- The UI remains responsive with loading states
- The application gracefully falls back to original bios when needed
- Console logs provide clear debugging information

The code is production-ready and can be deployed.

## Lessons

### User Specified Lessons

* Include info useful for debugging in the program output.
* Read the file before you try to edit it.
* If there are vulnerabilities that appear in the terminal, run npm audit before proceeding
* Always ask before using the -force git command

### Cursor learned

* When working with Next.js API routes, avoid importing modules that mix CommonJS and ES Module syntax
* For better compatibility, it's sometimes cleaner to reimplement utility functions directly in the API route
* In Node.js environments with mixed module systems, it's helpful to provide multiple export styles
* Caching API responses is crucial when working with third-party APIs like Perplexity to avoid rate limiting
* Using structured output formats like JSON Schema helps ensure consistent response formats from AI services
